# 《Python 机器学习 - 客户价值模型 RFM 构建 08 - 商品主题营销工具客服专属优惠》设计文档

## 一、项目背景

在电商数仓项目中，客服专属优惠是提升客服询单转化率、整体提升店铺销量的重要营销工具。为了更精准地发挥该工具的作用，需要构建客户价值模型 RFM，对客户进行分层，从而为不同价值的客户制定针对性的客服专属优惠策略。本设计文档旨在阐述基于 Python 机器学习的客户价值模型 RFM 构建，以及其与商品主题营销工具客服专属优惠的结合应用实现方案。

## 二、原始数据分析

### （一）数据来源

原始数据来源于 ODS 层的各类数据表，包括活动表（ods_customer_service_promo_activity）、活动 - 商品关联表（ods_customer_service_promo_activity_item）、优惠发送表（ods_customer_service_promo_send）、优惠核销表（ods_customer_service_promo_use）、商品表（ods_product）、SKU 表（ods_sku）、客服表（ods_customer_service）等。这些表涵盖了从活动创建、商品关联、优惠发送到客户核销的全流程数据。

### （二）数据内容

1. 活动表包含活动 ID、名称、级别、优惠类型、时间范围、状态等信息，记录了客服专属优惠活动的基本配置。

2. 活动 - 商品关联表记录了活动与商品 / SKU 的关联关系，包括优惠金额、限购次数等。

3. 优惠发送表记录了客服向客户发送优惠的明细，如发送 ID、活动 ID、商品信息、客服信息、客户 ID、发送时间等。

4. 优惠核销表记录了客户使用优惠的情况，包括使用 ID、发送 ID、订单信息、支付时间、支付金额等。

5. 商品表和 SKU 表包含商品及 SKU 的基本信息，如 ID、名称、价格、状态等。

6. 客服表包含客服的 ID、姓名、所属店铺等信息。

### （三）数据流转

原始数据经过 DWD 层的清洗与转换，形成活动明细事实表、活动 - 商品关联明细事实表、优惠发送明细事实表、优惠核销明细事实表等。随后在 DWS 层进行汇总，得到每日汇总表、活动汇总表、客服汇总表、商品汇总表等。最终在 ADS 层生成用于展示和分析的各类指标数据，为 RFM 模型构建提供数据支持。

## 三、ADS 层表设计

### （一）效果总览表（ads_customer_service_promo_overview）

|   |   |   |
|---|---|---|
|字段名|数据类型|说明|
|stat_period|string|统计周期（日 / 7 天 / 30 天）|
|user_level|string|用户等级（整体 / 流失用户 / 一般用户 / 潜力用户 / 高价值用户）|
|total_send_count|bigint|总发送次数|
|total_use_count|bigint|总核销次数|
|valid_use_count|bigint|有效核销次数|
|use_rate|decimal(5,2)|核销率|
|etl_load_time|timestamp|ETL 加载时间|

该表用于展示不同统计周期内，整体及不同 RFM 分层用户的客服专属优惠发送、核销情况及核销率等核心指标。

### （二）活动效果表（ads_customer_service_promo_activity_effect）

|   |   |   |
|---|---|---|
|字段名|数据类型|说明|
|activity_id|string|活动 ID|
|activity_name|string|活动名称|
|activity_status|string|活动状态|
|send_count|bigint|发送次数|
|use_count|bigint|核销次数|
|use_rate|decimal(5,2)|核销率|
|rank|int|活动排名|
|etl_load_time|timestamp|ETL 加载时间|

该表展示各活动的发送次数、核销次数、核销率及排名等信息，用于评估活动效果。

### （三）客服数据报表（ads_customer_service_performance）

|   |   |   |
|---|---|---|
|字段名|数据类型|说明|
|customer_service_id|string|客服 ID|
|cs_name|string|客服姓名|
|shop_id|string|店铺 ID|
|send_count|bigint|发送次数|
|use_count|bigint|核销次数|
|use_rate|decimal(5,2)|核销率|
|avg_promo_amount|decimal(10,2)|平均优惠金额|
|etl_load_time|timestamp|ETL 加载时间|

该表用于统计客服的工作绩效，包括发送次数、核销次数、核销率等指标。

### （四）发送明细汇总表（ads_customer_service_promo_send_detail）

|   |   |   |
|---|---|---|
|字段名|数据类型|说明|
|send_id|string|发送 ID|
|activity_id|string|活动 ID|
|product_id|string|商品 ID|
|product_name|string|商品名称|
|consumer_id|string|客户 ID|
|user_level|string|用户等级（RFM 分层）|
|customer_service_id|string|客服 ID|
|cs_name|string|客服姓名|
|send_time|timestamp|发送时间|
|use_status|string|使用状态（已核销 / 未核销）|
|use_time|timestamp|使用时间|
|etl_load_time|timestamp|ETL 加载时间|

该表汇总了优惠发送的明细信息，并关联了客户的 RFM 分层等级，便于分析不同层级客户的优惠使用情况。

## 四、关键指标实现方案

### （一）RFM 指标计算

1. **R（最近消费时间）**：计算客户最后一次使用客服专属优惠进行支付的时间距离当前时间的天数。若客户没有核销记录，则赋值为 999 天。

2. **F（消费频率）**：统计客户在统计周期内收到客服专属优惠的发送次数，以此代表消费频率。

3. **M（消费金额）**：计算客户在统计周期内使用客服专属优惠核销后的总支付金额。

### （二）RFM 打分与分层

1. 对 R、F、M 三个指标分别进行 1-5 分打分，其中 R 值越小得分越高，F 和 M 值越大得分越高。

2. 计算 R、F、M 得分的总和（rfm_total），根据总分将客户分为四类：

- 流失用户：rfm_total≤5

- 一般用户：5<rfm_total≤8

- 潜力用户：8<rfm_total≤12

- 高价值用户：rfm_total>12

### （三）核心业务指标计算

1. **发送次数**：统计指定周期内优惠发送的总次数，不分层时直接汇总所有发送记录，分层时按不同 RFM 用户等级分别汇总。

2. **核销次数**：统计指定周期内优惠被核销的总次数，同样支持整体和分层统计。

3. **核销率**：核销次数与发送次数的比值，计算公式为（核销次数 / 发送次数）×100%，保留两位小数。

## 五、实现思路

### （一）数据处理流程

1. 从 ODS 层读取原始数据，经过 DWD 层的清洗、转换和关联，生成各类明细事实表，确保数据的准确性和完整性。

2. 在 DWS 层对 DWD 层的数据进行汇总，按不同维度（如日期、活动、客服、商品等）聚合生成汇总表，为 ADS 层的指标计算提供基础。

3. 在 ADS 层，基于 DWS 层的汇总数据和 DWD 层的明细数据，分别采用不分层和分层（RFM）两种方式计算关键指标，生成相应的 ADS 层表。

### （二）RFM 模型构建与应用

1. 利用 [ads_fu_bu.py](http://ads_fu_bu.py) 中的 calculate_rfm 函数计算客户的 RFM 指标并进行分层。

2. 在优惠效果分析中，结合 RFM 分层结果，分析不同价值客户对客服专属优惠的响应情况，为制定针对性的优惠策略提供依据。例如，针对高价值客户可提供更高额度的优惠，针对流失用户可提供唤醒式优惠。

### （三）两种实现方式对比

1. **不分层实现方式**：直接对所有数据进行汇总计算，得到整体的发送次数、核销次数、核销率等指标，反映客服专属优惠的整体效果。

2. **分层实现方式**：按 RFM 用户等级分别计算各项指标，分析不同层级客户的优惠使用情况，有助于精准营销和资源优化配置。通过对比两种方式的结果，验证分层分析的合理性和有效性。

## 六、部署与测试说明

### （一）部署环境

本项目需在 spark3.2 及以上版本的环境中部署，使用 PySpark+Sparksql 进行实现。

### （二）代码注释要求

所有代码注释需包含工单编号：大数据 - 电商数仓 - 08 - 商品主题营销工具客服专属优惠看板，确保代码的可追溯性。

### （三）测试要点

1. 验证分层和不分层两种实现方式计算出的指标数据是否一致，确保数据的准确性。

2. 测试 RFM 指标计算的准确性，以及客户分层的合理性。

3. 检查各 ADS 层表的字段完整性和数据正确性。