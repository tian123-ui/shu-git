# 《Python 机器学习 - 挖掘标签模型开发及算法模型构建 09 - 流量主题店内路径看板》设计文档（终版）
#电商数仓-09-流量主题店内路径看板

## 项目概述:

本设计围绕电商数仓中流量主题的店内路径看板，结合 Python 机器学习技术，构建从原始数据处理、数仓分层设计到模型开发与看板联动的完整体系，助力电商商家深入洞察用户路径，实现 “数据展示 - 模型分析 - 业务决策” 闭环。

## 一、原始数据分析

### 1.1 数据来源与范围

- **数据层级**：源于电商数仓 ODS 层，存储未经加工的原始用户行为日志，数据量需大于 100 万条，且需进行性能优化以支撑后续处理。
- **覆盖终端**：同时包含无线端和 PC 端数据，可分别展示无线端进店页面的访客数、下单买家数等，以及 PC 端访客的来源页面 TOP20 和来源占比图。
- **核心字段**：涵盖访客 ID、访问时间、页面类型（店铺页 / 商品详情页 / 店铺其他页）、来源页面、去向页面、停留时长、下单买家数等。
- **时间维度**：支持日 / 7 天 / 30 天 / 月维度查询，满足商家对不同周期内消费者路径的分析需求。

### 1.2 数据核心特性

- **页面分类体系**：
    - 店铺页：包括首页、活动页、分类页、宝贝页、新品页等店铺内主要页面；
    - 商品详情页：商品的基础详情页面，用于展示商品详细信息；
    - 店铺其他页：不属于前两类的兜底页面，如订阅页、直播页等。
- **路径特殊属性**：
    - 不重复性：各页面之间不查重，来源 / 去向数据加总可能大于总数据；
    - 多向性：一个访客可能来自多个页面或去往多个页面，存在来源≠去向的情况。

### 1.3 业务目标

帮助电商商家了解消费者的进店路径和店内流转情况，从而更好地规划店铺产品、提高消费者购物体验。

## 二、数据分层设计（ODS→DIM→DWD→DWS→ADS）及核心字段

### （一）分层架构流程图

![[Pasted image 20250801111859.png]]

### 2.1 ODS 层（操作数据存储层）

- **核心定位**：存储原始、未经加工的用户行为及页面访问明细数据，为后续各层提供基础数据源。
- **核心字段**：访客 ID、访问时间、页面名称、页面类型（店铺页 / 商品详情页 / 店铺其他页）、来源页面、去向页面、停留时长、终端类型（无线 / PC）、是否下单、下单买家 ID 等。
- **关键要求**：数据量需大于 100 万条，需进行性能优化以支撑后续处理。

### 2.2 DIM 层（维度表层）

- **核心定位**：构建业务维度表，规范关键维度定义与编码，为数据分析提供统一基准。
- **主要维度表及核心字段**：
    - 页面维度表（dim_page）：页面 ID、页面类型（店铺页 / 商品详情页 / 店铺其他页）、页面细分类型（首页 / 活动页 / 订阅页等）、页面名称。
    - 时间维度表（dim_time）：时间 ID、时间粒度（日 / 7 天 / 30 天 / 月）、日期编码、具体日期。
    - 设备维度表（dim_device）：设备 ID、终端类型（无线 / PC）、设备标识。

### 2.3 DWD 层（明细数据层）

- **核心定位**：对 ODS 层数据进行清洗、转换与关联，生成结构化的明细事实数据，保留最细粒度的用户行为信息。
- **主要事实表及核心字段**：
    - 用户页面访问明细事实表（dwd_user_page_visit_detail）：访客 ID、访问时间 ID（关联 dim_time）、页面 ID（关联 dim_page）、页面类型、来源页面 ID、去向页面 ID、停留时长、设备 ID（关联 dim_device）、是否下单（1/0）、下单买家 ID（若下单）。

### 2.4 DWS 层（汇总数据层）

- **核心定位**：基于 DWD 层明细数据，按业务需求进行多维度汇总，生成中层汇总指标，支撑 ADS 层展示。
- **主要汇总表及核心字段**：
    - 页面访问指标汇总表（dws_page_visit_stats）：时间粒度、页面类型、设备类型、访客数、浏览量、平均停留时长、下单买家数。
    - 店内路径流转汇总表（dws_instore_path_flow_stats）：时间粒度、设备类型、来源页面 ID、去向页面 ID、访客数。
    - PC 端流量入口汇总表（dws_pc_traffic_entry_stats）：时间粒度、来源页面、访客数、来源占比。

### 2.5 ADS 层（应用数据层）

- **核心定位**：基于 DWS 层汇总数据，生成直接支撑 “店内路径看板” 展示的指标数据，满足商家路径分析需求。
- **主要应用表及核心字段**：
    - 无线端入店与承接指标表（ads_wireless_entry_receive）：时间维度、进店页面类型、访客数、下单买家数。
    - 页面访问排行表（ads_page_visit_rank）：时间维度、设备类型、页面类型、页面名称、访客数、浏览量、平均停留时长（按访客数或浏览量排序）。
    - 店内路径展示表（ads_instore_path_display）：时间维度、设备类型、页面名称、来源页面名称、来源访客数、去向页面名称、去向访客数、来源占比、去向占比。
    - PC 端流量入口 TOP20 表（ads_pc_entry_top20）：时间维度、来源页面、访客数、来源占比（取前 20 名）。

## 三、关键指标实现方案

### 3.1 基础访问指标

- **页面访客数**：直接累加原始日志中各页面的访问记录（因页面不去重，支持多来源 / 去向数据累加）。

- **页面访问排行**：按访客数或浏览量降序排序，区分店铺页、商品详情页、店铺其他页三类页面单独排行。

- **平均停留时长**：某一页面的总停留时长除以访问该页面的访客数（保留不去重特性）。


### 3.2 流量入口指标（PC 端）

- **PC 端来源页面 TOP20 及占比**：统计 PC 端访客的来源页面，按访客数降序取前 20 名，并计算各来源页面访客数占 PC 端总访客数的比例。


### （三）路径流转指标
### 3.3 路径流转指标

- **来源 / 去向占比**：基于店内路径流转汇总表，计算各页面作为来源或去向的访客数占比，需说明 “不查重” 导致的加总可能大于总数据的情况。
- **路径转化率**：计算从某一页面到下单页面的转化比例（如商品详情页到下单页的下单买家数 / 商品详情页访客数）。


## 四、性能优化方案

### 4.1 数据分层预处理

- 在 DWS 层构建预聚合表（如`dws_page_daily_agg`），按日 / 终端类型 / 页面类型提前聚合基础指标（访客数、总停留时长等），减少 ADS 层计算的数据量，适配 ODS 层 100 万 + 数据量需求。

### 4.2 索引与存储优化

- **分区策略**：ADS 层表按`stat_date`（统计日期）和`store_id`（店铺 ID）分区，便于快速筛选不同时间段和店铺的数据。
- **索引设计**：对`time_period`（时间周期）、`terminal_type`（终端类型）、`page_type`（页面类型）建立联合索引，提升多维度查询效率。

### 4.3 模型轻量化处理

- **增量训练**：仅对新增数据进行模型训练，减少重复计算；

运行


- **低置信度过滤**：查询时过滤置信度低于 0.5 的标签，减少无效数据处理；


- **特征降维**：使用 PCA 等方法对模型输入特征降维，降低计算复杂度。

## 五、挖掘标签模型与算法模型构建

### 5.1 挖掘标签模型开发

- **用户路径标签**：基于 DWS 层流转数据，生成 “首页→商品详情页→下单”“直播页→分类页” 等典型路径标签，标识高频用户行为路径。
- **页面转化标签**：计算各页面间的转化效率，生成 “高转化页面”“低转化页面” 等标签，辅助商家识别关键页面。

### 5.2 算法模型构建

- **序列模式挖掘模型**：使用 Python 的`mlxtend`库，通过 Apriori 或 SPADE 算法挖掘用户访问页面的频繁序列，识别最常走的进店及店内流转路径，为产品布局提供依据。



- **路径预测模型**：基于用户历史访问序列，使用 LSTM 等深度学习模型（借助`TensorFlow/PyTorch`实现），预测用户下一步可能访问的页面，优化页面跳转设计。


## 六、实现思路与验证机制

### 6.1 数据链路

ODS 层（原始日志）→DWD 层（清洗与维度关联）→DWS 层（基础指标预聚合）→模型层（标签挖掘与预测）→ADS 层（看板展示数据）。

### 6.2 关键技术与工具

- 数据存储与处理：采用 HDFS 存储数据，使用 Spark 进行分布式处理，通过 Spark SQL 实现 DWD 层清洗与关联；
- 机器学习框架：借助 Scikit-learn、TensorFlow 等实现模型构建；
- 代码规范：代码需包含明确注释，且注释中必须包含工单编号 “大数据 - 电商数仓 - 09 - 流量主题店内路径看板”。

### 6.3 验证机制

- **分层与不分层数据一致性测试**：通过 SQL 验证分层（无线端 / PC 端）与不分层数据的访客数、下单买家数等指标一致性，要求分层数据之和≤不分层数据（允许跨终端重复计数）；



- **模型评估**：通过准确率、覆盖率等指标评估路径预测模型，确保高频路径覆盖率≥70%，去向预测准确率≥60%。

## 七、产出物与验收标准

### 7.1 产出物

1. 店内路径看板设计文档（含 ADS 层表设计、原始数据分析、关键指标实现方案、性能优化方案及明确实现思路）；
2. 店内路径看板代码（实现全部指标功能，包含不分层、分层两种方式，代码有明确注释）；
3. 店内路径看板测试文档（含测试记录及测试 SQL，分层与不分层数据一致）；
4. 店内路径看板上线截图（含截图时间，能清晰看到指标数值）。

### 7.2 核心验收标准

- ODS 层数据量＞100 万条，且性能优化达标；
- 设计文档逻辑清晰，覆盖全部要求；
- 代码注释包含指定工单编号，功能完整；
- 测试文档数据一致，上线截图指标清晰。
